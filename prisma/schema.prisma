generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Ad {
  id            String    @id @default(cuid())
  name          String    // Auto-generado: FECHA_CONCEPTO_ANGULO_FORMATO
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // === NOMENCLATURA (Identificación única) ===
  concept       String    // Mensaje central en 3-4 palabras (ej: "Ahorro de dinero")
  angle         String    // Ángulo psicológico
  format        String    // "static" | "video" | "ugc" | "carousel"
  funnelStage   String    // "cold" | "retargeting"
  product       String?   // Producto específico si vendes varios

  // === MÓDULO INTENCIÓN (Obligatorio) ===
  hypothesis    String    // "Creo que funcionará porque..."
  sourceType    String    @default("original") // "original" | "competitor" | "iteration"
  sourceUrl     String?   // URL si es de competencia
  referenceMediaUrl String? // Video/imagen de referencia subido

  // === ESTADO (Pipeline Kanban) ===
  status        String    @default("idea")
  // Estados: "idea" | "production" | "testing" | "analysis" | "completed"

  // === DEADLINE ===
  dueDate       DateTime? // Fecha limite para completar el ad

  // === DESARROLLO CREATIVO ===
  script        String?   // Guion del anuncio
  hook          String?   // Hook principal (primeros 3 segundos)
  cta           String?   // Call to action
  notes         String?   // Notas adicionales de desarrollo

  // === REGLA DE LOS 10 DÍAS ===
  testingStartedAt  DateTime?  // Cuando se movió a "testing"
  reviewDate        DateTime?  // testingStartedAt + 10 días (auto-calculado)
  testingBudget     Float?     // Presupuesto asignado al test
  isLocked          Boolean    @default(false) // True mientras está en testing
  lockDays          Int        @default(10)    // Días de bloqueo configurables

  // === MÉTRICAS (Ingreso manual) ===
  spend         Float?
  impressions   Int?
  clicks        Int?
  purchases     Int?
  revenue       Float?

  // === MÉTRICAS DE VIDEO ===
  videoViewThreeSeconds  Int?    // Vistas de 3 segundos
  videoViewThruplay      Int?    // Vistas completas (o 15 seg si video > 15 seg)
  // Hook Rate = videoViewThreeSeconds / impressions (< 20% = hook malo)
  // Hold Rate = videoViewThruplay / videoViewThreeSeconds (guion aburrido si bajo)

  // === POST-MORTEM (Análisis final) ===
  result        String?   // "winner" | "loser"
  diagnosis     String?   // "¿Por qué ganó/perdió?"
  action        String?   // "iterate" | "kill" | "scale"
  closedAt      DateTime?

  // === ETIQUETAS DE FALLO/ÉXITO (Para análisis cuantitativo) ===
  failReasons      String?   // JSON array: ["bad_hook", "boring_script"]
  successFactors   String?   // JSON array: ["high_contrast", "urgency"]

  // === EVALUACIÓN POR ELEMENTOS ===
  hookResult    String?   // "worked" | "failed" | null
  hookNote      String?   // El hook exacto que funciono/fallo
  avatarResult  String?   // "worked" | "failed" | null
  avatarNote    String?   // Descripcion del avatar/presentador
  scriptResult  String?   // "worked" | "failed" | null
  scriptNote    String?   // Parte del guion que destaco
  ctaResult     String?   // "worked" | "failed" | null
  ctaNote       String?   // El CTA exacto
  visualResult  String?   // "worked" | "failed" | null
  visualNote    String?   // Que elemento visual funciono/fallo
  audioResult   String?   // "worked" | "failed" | null
  audioNote     String?   // Que musica/sonido uso

  // === MEDIA ===
  thumbnailUrl  String?   // URL o path de la imagen/video

  // === RELACIONES ===
  learnings     Learning[]

  // Conexión con Avatar (a quién le habla este ad)
  avatarId      String?
  avatar        Avatar?  @relation(fields: [avatarId], references: [id], onDelete: SetNull)
}

model Learning {
  id        String   @id @default(cuid())
  content   String   // La lección: "El fondo negro funcionó mejor"
  type      String   @default("insight") // "insight" | "rule" | "warning"
  createdAt DateTime @default(now())

  ad        Ad?      @relation(fields: [adId], references: [id], onDelete: SetNull)
  adId      String?

  // Para búsqueda por tags
  angle     String?  // Copiado del ad para filtrar
  format    String?
  result    String?  // winner/loser

  // Evaluación por elementos (copiado del ad)
  hookResult    String?
  hookNote      String?
  avatarResult  String?
  avatarNote    String?
  scriptResult  String?
  scriptNote    String?
  ctaResult     String?
  ctaNote       String?
  visualResult  String?
  visualNote    String?
  audioResult   String?
  audioNote     String?

  // Etiquetas (copiado del ad)
  failReasons      String?
  successFactors   String?
}

model Settings {
  id              String  @id @default("default")
  defaultLockDays Int     @default(10)
  defaultBudget   Float   @default(50)
}

// === MÓDULO DE RESEARCH ===

model Avatar {
  id            String         @id @default(cuid())
  name          String         // Ej: "Madres primerizas estresadas"
  description   String?        // Descripción general del avatar

  // Luchas diarias específicas (no genérico)
  painPoints    String         // JSON array de pain points específicos
  // Ej: ["Le da vergüenza ir a la piscina con sus hijos", "Se despierta a las 3am por ansiedad"]

  // Deseos y aspiraciones
  desires       String         // JSON array de deseos específicos
  // Ej: ["Quiere sentirse cómoda en su cuerpo", "Quiere tener energía para jugar con sus hijos"]

  // Objeciones comunes
  objections    String?        // JSON array de objeciones
  // Ej: ["No tengo tiempo", "Ya probé todo y nada funciona"]

  // Estilo de contenido orgánico que consume
  organicStyle  String?        // Qué tipo de contenido ve cuando NO ve ads
  // Ej: "TikToks de chicas hablando a cámara 3min, videos de transformación, testimonios raw"

  // Lenguaje que usa (para copy)
  language      String?        // Frases, palabras, expresiones que usa este avatar

  // Demografía básica (opcional)
  ageRange      String?        // Ej: "25-40"
  gender        String?        // Ej: "female", "male", "all"
  location      String?        // Ej: "LATAM", "España", "US Hispanic"

  // Relaciones
  research      ResearchItem[]
  ads           Ad[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model ResearchItem {
  id          String   @id @default(cuid())

  // Fuente del hallazgo
  source      String   // "Reddit", "TikTok Comments", "Facebook Group", "Amazon Review", "YouTube Comments", "Twitter"
  url         String?  // URL de donde se sacó

  // El contenido/quote directo
  content     String   // Ej: "Me despierto a las 3am por sudores fríos y mi esposo ni se entera"

  // Categorización
  category    String   // "pain_point", "desire", "objection", "language", "insight"

  // Contexto adicional
  context     String?  // Contexto de dónde/cómo se encontró

  // Etiquetas para búsqueda
  tags        String?  // JSON array de tags: ["sueño", "menopausia", "relación"]

  // Conexión con avatar
  avatarId    String?
  avatar      Avatar?  @relation(fields: [avatarId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
}
